---
phase: 04-tech-debt-test-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - cypress.config.ts
autonomous: true
requirements:
  - INFR-02
  - TEST-05

must_haves:
  truths:
    - 'Deployment is blocked when any Cypress test fails'
    - 'Cypress tests never auto-retry on failure — flaky tests surface immediately'
  artifacts:
    - path: '.github/workflows/deploy.yml'
      provides: 'CI gate: deploy depends on cypress job'
      contains: 'needs: [build, cypress]'
    - path: 'cypress.config.ts'
      provides: 'Cypress config without retries'
  key_links:
    - from: '.github/workflows/deploy.yml deploy job'
      to: '.github/workflows/deploy.yml cypress job'
      via: 'needs dependency'
      pattern: "needs:\\s*\\[build,\\s*cypress\\]"
---

<objective>
Add CI quality gate and remove Cypress retries.

Purpose: Deployment must be blocked when Cypress tests fail (hard gate, no exceptions). Retries mask flaky tests — removing them ensures every failure is a real signal that must be fixed.

Output: Updated deploy.yml with deploy gated on cypress, updated cypress.config.ts with retries removed.
</objective>

<execution_context>
@/Users/jacobstoragepug/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacobstoragepug/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/deploy.yml
@cypress.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate deployment on Cypress test results</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
    In `.github/workflows/deploy.yml`, change the `deploy` job's `needs` field from `needs: build` to `needs: [build, cypress]`.

    This ensures the deploy job will not run unless BOTH the build AND cypress jobs pass. Keep the existing `build` dependency — removing it would break the artifact upload sequence (build uploads the `out/` directory that deploy uses).

    Do NOT modify any other part of the workflow file. The cypress job itself is already correct (runs on every push, uses cypress-io/github-action@v6).

  </action>
  <verify>
    Read `.github/workflows/deploy.yml` and confirm the deploy job has `needs: [build, cypress]`.
    Run `npx yaml-lint .github/workflows/deploy.yml 2>/dev/null || echo "lint skipped"` or manually verify YAML syntax is valid.
  </verify>
  <done>deploy job depends on both build and cypress jobs — deployment is impossible when Cypress tests fail</done>
</task>

<task type="auto">
  <name>Task 2: Remove Cypress retry configuration</name>
  <files>cypress.config.ts</files>
  <action>
    In `cypress.config.ts`, remove the entire `retries` block:

    ```
    retries: {
      runMode: 2,
      openMode: 0,
    },
    ```

    Per user decision: "No retry mechanism: any failure is a real failure. Fix the flaky test, don't mask it."

    Keep all other config options unchanged (baseUrl, viewportWidth, viewportHeight, video, screenshotOnRunFailure, setupNodeEvents).

  </action>
  <verify>
    Read `cypress.config.ts` and confirm:
    1. No `retries` key exists anywhere in the config
    2. All other config options are preserved
    3. File compiles: `npx tsc --noEmit cypress.config.ts 2>/dev/null || echo "type check skipped"`
  </verify>
  <done>Cypress runs each test exactly once — no retries in runMode or openMode</done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` deploy job has `needs: [build, cypress]`
2. `cypress.config.ts` has no `retries` configuration
3. Both files are syntactically valid
</verification>

<success_criteria>

- deploy.yml gates deployment behind Cypress test results
- cypress.config.ts has zero retry configuration
- No other changes to either file
  </success_criteria>

<output>
After completion, create `.planning/phases/04-tech-debt-test-quality/04-01-SUMMARY.md`
</output>
